<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Search</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        main {
            margin: 100px 50px;
        }
        form {
            border: 1px solid #ffbb00;
        }
        h1 {
            margin-bottom: 30px;
        }
        @media screen and (max-width: 600px) {
            main {
                margin: 100px 20px;
            }
            h1 {
                font-size: 1rem;
                margin-bottom: 15px;
            }
            form {
                width: 80%;
            }
        }
        select {
            border-radius: 5px; background-color: #000; color: #fff; border: 1px solid #8b8b8b;
        }
        #pagination { margin: 20px 0; }
        .pagination-button { margin: 0 5px; cursor: pointer; }
        .pagination-button:disabled { cursor: not-allowed; }
        button {
            background-color: transparent;
            outline: none;
            border: 1px solid #8b8b8b;
            border-radius: 5px;
            color: #fff;
            padding: 0px 14px;
            cursor: pointer;
        }
        
        input:focus,
        select:focus,
        button:hover {
            border: 1px solid #ffbb00 !important;
        }
    </style>
</head>
<body>
    <header>
        <a href="./"><img src="logotype.svg" alt="KinoBox"></a>
    </header>
    <div id="loader">
        <div class="spinner">
            <img src="logotype.svg" alt="">
        </div>
    </div>
    <main>
        <h1>Поиск фильмов</h1>
        <section style="display: flex; gap: 20px;">   
            <input type="text" id="search" placeholder="Название фильма" autocomplete="off" style="width: 100%; padding: 10px; background-color: transparent; outline: none; border: 1px solid #8b8b8b; border-radius: 5px; color: #fff;">
            <select id="genre">
                <option value="">Все жанры</option>
                <option value="1">Триллер</option>
                <option value="2">Драма</option>
                <option value="3">Криминал</option>
                <option value="4">Мелодрама</option>
                <option value="5">Детектив</option>
                <option value="6">Фантастика</option>
                <option value="7">Приключения</option>
                <option value="8">Биография</option>
                <!-- <option value="9">Фильм-нуар</option> -->
                <option value="10">Вестерн</option>
                <option value="11">Боёвик</option>
                <option value="12">Фэнтези</option>
                <option value="13">Комедия</option>
                <option value="14">Военный</option>
                <option value="15">История</option>
                <!-- <option value="16">Музыка</option> -->
                <option value="17">Ужасы</option>
                <option value="18">Мультфильм</option>
                <option value="19">Семейный</option>
                <option value="20">Мюзикл</option>
                <!-- <option value="21">Спорт</option> -->
                <option value="22">Документальный</option>
                <option value="23">Короткометражка</option>
                <option value="24">Аниме</option>
                <!-- <option value="25">Не указан</option>
                <option value="26">Новости</option>
                <option value="27">Концерт</option>
                <option value="28">Для взрослых</option>
                <option value="29">Церемония</option>
                <option value="30">Реальное ТВ</option>
                <option value="31">Игра</option>
                <option value="32">Ток-шоу</option> -->
                <option value="33">Детский</option>
            </select>
            <select id="country">
                <option value="">Все страны</option>
                <option value="1">США</option>
                <option value="3">Франция</option>
                <option value="5">Великобритания</option>
                <option value="7">Индия</option>
                <option value="9">Германия</option>
                <option value="10">Италия</option>
                <option value="15">Мексика</option>
                <option value="16">Япония</option>
                <option value="21">Китай</option>
                <option value="22">Норвегия</option>
                <option value="28">Тайвань</option>
                <option value="33">СССР</option>
                <option value="34">Россия</option>
                <option value="44">Турция</option>
                <option value="49">Корея Южная</option>
                <option value="8">Испания</option>
                <option value="106">Украина</option>
                <option value="165">Корея</option>
                <option value="14">Канада</option>
            </select>
            <button id="search-button">Поиск</button>
        </section>
        <div id="film-container" class="film-container"></div>
        <div id="pagination"></div>
    </main>
    
    <script src="js/script.js"></script>
    <script>
        const API_URL = 'https://kinopoiskapiunofficial.tech/api/v2.2/films';
        const API_KEY = '778c4001-18d0-4e13-8699-6b398f196b1a'; // Убедитесь, что вы добавили свой API-ключ здесь

        async function fetchFilms(page = 1) {
            const searchInput = document.getElementById('search').value.trim();
            const genreSelect = document.getElementById('genre');
            const countrySelect = document.getElementById('country');
            const genre = genreSelect.value;
            const country = countrySelect.value;
            const sort = 'RATING'; // Или 'YEAR'
            
            let url = `${API_URL}?order=${sort}&type=ALL&ratingFrom=0&ratingTo=10&yearFrom=1000&yearTo=2024&page=${page}`;

            if (genre) url += `&genres=${genre}`;
            if (country) url += `&countries=${country}`;
            if (searchInput) url += `&keyword=${encodeURIComponent(searchInput)}`;

            console.log(`Fetching data from: ${url}`); // Отладочное сообщение

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-API-KEY': API_KEY
                    }
                });
                const data = await response.json();

                console.log('Response data:', data); // Отладочное сообщение

                if (data && data.items) {
                    displayFilms(data.items);
                    setupPagination(data.totalPages, page);
                } else {
                    displayNoFilms();
                }
            } catch (error) {
                console.error('Error fetching films:', error);
                displayNoFilms();
            }
        }

        function displayFilms(films) {
            const filmContainer = document.getElementById('film-container');
            filmContainer.innerHTML = ''; // Clear previous results

            if (films.length > 0) {
                films.forEach(film => {
                    console.log('Processing film:', film); // Отладочное сообщение

                    const filmCard = document.createElement('a');
                    filmCard.className = 'film';
                    filmCard.href = `film?id=${film.kinopoiskId}`;
                    
                    const rating = film.ratingKinopoisk || 'No Rating';
                    const posterUrl = film.posterUrlPreview || 'default.jpg';
                    const year = film.year || 'Unknown Year';
                    const name = film.nameRu || film.nameOriginal || 'Unknown Title';

                    filmCard.innerHTML = `
                        <img src="${posterUrl}" alt="${name}">
                        <p>${name}</p>
                        <p class="film__year">${year}</p>
                        <p class="film__rating">${rating}</p>
                    `;

                    filmContainer.appendChild(filmCard);
                });
            } else {
                displayNoFilms();
            }
        }

        function displayNoFilms() {
            const filmContainer = document.getElementById('film-container');
            filmContainer.innerHTML = '<p>No films found</p>';
        }

        function setupPagination(totalPages, currentPage) {
            const paginationContainer = document.getElementById('pagination');
            paginationContainer.innerHTML = '';

            if (totalPages > 1) {
                for (let i = 1; i <= totalPages; i++) {
                    const button = document.createElement('button');
                    button.textContent = i;
                    button.className = 'pagination-button';
                    if (i === currentPage) button.disabled = true;
                    button.addEventListener('click', () => fetchFilms(i));
                    paginationContainer.appendChild(button);
                }
            }
        }

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function setFormValuesFromUrl() {
            const search = getUrlParameter('search');
            const genre = getUrlParameter('genre');
            const country = getUrlParameter('country');

            if (search) document.getElementById('search').value = decodeURIComponent(search);
            if (genre) document.getElementById('genre').value = genre;
            if (country) document.getElementById('country').value = country;
        }

        document.getElementById('search-button').addEventListener('click', () => fetchFilms(1));

        // Set form values from URL on page load
        setFormValuesFromUrl();

        // Initial fetch
        fetchFilms();

    </script>
</body>
</html>
