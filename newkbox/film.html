<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title></title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body class="page">
    <header>
        <a href="./"><img src="logotype.svg" alt="KinoBox"></a>
        <form action="search">
            <input type="text" name="search" placeholder="Поиск фильмов">
            <button type="submit">Найти</button>
        </form>
    </header>
    <div id="loader">
        <div class="spinner">
            <img src="logotype.svg" alt="">
        </div>
    </div>
    <main>
        <section class="film__start">
            <img src="img.png" class="film__start-img" alt="">
            <img id="film__start-img" src="" alt="">
            <div class="film__start-nav">
                <img src="" id="film__logo" alt="">
                <h1 id="film__title"></h1>
                <p id="film__description"></p>
                <div style="display: flex; flex-direction: row; gap: 10px;">
                    <p id="film__year"></p>
                    <p id="film__rating"></p>
                </div>
                <a href="" id="film__link" class="film__start-btn">Смотреть онлайн</a>
            </div>
        </section>
        <h2 class="film__similar-h2">Похожие фильмы</h2>
        <section class="film-container" id="film__similar">
            
        </section>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script>
        gsap.fromTo("body", { opacity: 0 }, { opacity: 1, duration: 0.5 });
    </script>
    <script src="js/script.js"></script>
    <script>
        function getParameterByName(name) {
    const url = window.location.href;
    const nameRegex = name.replace(/[\[\]]/g, '\\$&');
    const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
    const results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

// Получаем ID из URL
const filmId = getParameterByName('id');

// Определяем API-ключ и базовый URL для запросов
const apiKey = '778c4001-18d0-4e13-8699-6b398f196b1a';
const baseUrl = `https://kinopoiskapiunofficial.tech/api/v2.2/films/${filmId}`;

// Функция для получения данных о фильме
function fetchFilmDetails() {
    fetch(baseUrl, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-API-KEY': apiKey
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Response from Kinopoisk API:', data);

        // Извлекаем данные из ответа API
        const { description, coverUrl, posterUrl, logoUrl, nameRu, nameOriginal, year, ratingKinopoisk } = data;
        const title = nameRu || nameOriginal;

        // Устанавливаем изображение
        const filmImage = document.getElementById('film__start-img');
        filmImage.src = coverUrl || posterUrl;

        document.title = `${title} — Kinobox`;

        // Управляем логотипом и заголовком
        const logoElement = document.getElementById('film__logo');
        const titleElement = document.getElementById('film__title');

        if (logoUrl) {
            logoElement.src = logoUrl;
            logoElement.style.display = 'block';
            titleElement.style.display = 'none'; // Скрываем заголовок
        } else {
            logoElement.style.display = 'none'; // Скрываем логотип
            titleElement.textContent = title || 'Название фильма';
            titleElement.style.display = 'block'; // Показываем заголовок
        }

        // Устанавливаем дополнительную информацию
        document.getElementById('film__year').textContent = year || 'Год не указан';
        document.getElementById('film__rating').textContent = ratingKinopoisk || 'Нет рейтинга';
        document.getElementById('film__description').textContent = description || 'Описание отсутствует';
        document.getElementById('film__link').href = `player?id=${filmId}`;
    })
    .catch(error => {
        console.error('Error fetching data:', error);
    });
}

// Функция для получения похожих фильмов
async function fetchSimilarFilms() {
    const url = `${baseUrl}/similars`;

    try {
        console.log(`Fetching similar films from: ${url}`); // Отладочное сообщение

        const response = await fetch(url, {
            method: 'GET',
            headers: {
                'X-API-KEY': apiKey
            }
        });

        if (!response.ok) {
            throw new Error(`Ошибка сети: ${response.status}`);
        }

        const data = await response.json();
        console.log('Similar films data:', data); // Отладочное сообщение

        displaySimilarFilms(data.items); // Вызов функции для отображения фильмов
    } catch (error) {
        console.error('Ошибка при получении похожих фильмов:', error);
    }
}

// Функция для отображения похожих фильмов на странице
function displaySimilarFilms(films) {
    const filmMoreSection = document.querySelector('.film-container');
    
    if (!filmMoreSection) return;
    
    
    // Если фильмы не найдены, отображаем сообщение
    if (films.length === 0) {
        filmMoreSection.innerHTML += '<p>Похожих фильмов пока нет.</p>';
        return;
    }

    // Если фильмы найдены, добавляем их
    films.forEach(film => {
        const filmElement = document.createElement('a');
        filmElement.className = 'film';
        filmElement.href = `film.html?id=${film.filmId}`; // Используем ID из API
        filmElement.innerHTML = `
            <img src="${film.posterUrl}" alt="${film.nameRu}" />
            <p>${film.nameRu}</p>
        `;
        filmMoreSection.appendChild(filmElement);
    });
}
// Проверяем, есть ли ID фильма, и вызываем необходимые функции
if (filmId) {
    fetchFilmDetails();
    fetchSimilarFilms();
} else {
    console.error('ID фильма не найден в URL');
}
    </script>
</body>
</html>
